{% extends "dashboard_layout.html" %}

{% block page_title %}{{ account.account_name }}{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
        <div>
            <h2 class="text-2xl font-bold text-gray-900 dark:text-white">{{ account.account_name }}</h2>
            <p class="text-gray-500 dark:text-gray-400">{{ account.bank_name or 'Bank Account' }}</p>
        </div>
        <div class="flex items-center space-x-3">
            <a href="{{ url_for('banking.list_accounts') }}" class="inline-flex items-center px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white transition">
                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z" clip-rule="evenodd"/>
                </svg>
                Back to Accounts
            </a>
        </div>
    </div>

    <!-- Account Info Cards -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        <!-- Account Info -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Account Details</h3>
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Account Name</p>
                    <p class="font-medium text-gray-900 dark:text-white">{{ account.account_name }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Bank Name</p>
                    <p class="font-medium text-gray-900 dark:text-white">{{ account.bank_name or '-' }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Account Number</p>
                    <p class="font-medium text-gray-900 dark:text-white">{{ account.account_number or '-' }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Currency</p>
                    <p class="font-medium text-gray-900 dark:text-white">{{ account.currency }}</p>
                </div>
                {% if account.chart_of_account_name %}
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Linked COA Account</p>
                    <p class="font-medium text-gray-900 dark:text-white">{{ account.chart_of_account_name }}</p>
                </div>
                {% endif %}
            </div>
        </div>

        <!-- Balance -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Balance</h3>
            <div class="text-center">
                <p class="text-sm text-gray-500 dark:text-gray-400">Current Balance</p>
                <p class="text-4xl font-bold text-gray-900 dark:text-white mt-2">{{ (account.current_balance or 0)|currency }}</p>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-2">{{ account.currency }}</p>
            </div>
            <div class="mt-4 pt-4 border-t dark:border-gray-700">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-500 dark:text-gray-400">Opening Balance</span>
                    <span class="text-gray-900 dark:text-white">{{ (account.opening_balance or 0)|currency }}</span>
                </div>
            </div>
        </div>

        <!-- Reconciliation -->
        <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700 p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Last Reconciliation</h3>
            {% if account.last_reconciliation_date %}
            <div class="space-y-4">
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Date</p>
                    <p class="font-medium text-gray-900 dark:text-white">{{ account.last_reconciliation_date }}</p>
                </div>
                <div>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Balance</p>
                    <p class="font-medium text-gray-900 dark:text-white">{{ (account.last_reconciliation_balance or 0)|currency }}</p>
                </div>
            </div>
            {% else %}
            <p class="text-gray-500 dark:text-gray-400">No reconciliation recorded.</p>
            {% endif %}
            <div class="mt-4">
                <a href="{{ url_for('banking.reconciliation') }}" class="font-medium text-primary-600 dark:text-primary-500 hover:underline">
                    Start Reconciliation
                </a>
            </div>
        </div>
    </div>

    <!-- Transaction History -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
        <!-- Filter Header -->
        <div class="p-6 border-b dark:border-gray-700">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Transaction History</h3>
                
                <!-- Date Filter Form -->
                <form method="GET" class="flex flex-wrap items-center gap-3">
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600 dark:text-gray-400">From:</label>
                        <input type="date" name="start_date" value="{{ start_date or '' }}" 
                               class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="text-sm text-gray-600 dark:text-gray-400">To:</label>
                        <input type="date" name="end_date" value="{{ end_date or '' }}" 
                               class="px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700 text-gray-900 dark:text-white text-sm focus:ring-primary-500 focus:border-primary-500">
                    </div>
                    <button type="submit" class="px-4 py-2 bg-primary-600 text-white rounded-lg text-sm font-medium hover:bg-primary-700 transition">
                        Filter
                    </button>
                    <a href="{{ url_for('banking.view_account', account_id=account.id) }}" class="px-4 py-2 text-gray-600 dark:text-gray-400 hover:text-gray-900 dark:hover:text-white text-sm">
                        Clear
                    </a>
                </form>

                <!-- Export Buttons -->
                <div class="flex items-center gap-2">
                    {% set filter_params = '' %}
                    {% if start_date or end_date %}
                        {% set filter_params = '?start_date=' + (start_date or '') + '&end_date=' + (end_date or '') %}
                    {% endif %}
                    <a href="{{ url_for('banking.download_statement_pdf', account_id=account.id, start_date=start_date or '', end_date=end_date or '') }}" 
                       target="_blank"
                       class="inline-flex items-center px-4 py-2 bg-red-600 text-white rounded-lg text-sm font-medium hover:bg-red-700 transition">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                        </svg>
                        PDF
                    </a>
                    <a href="{{ url_for('banking.download_statement_excel', account_id=account.id, start_date=start_date or '', end_date=end_date or '') }}" 
                       class="inline-flex items-center px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-medium hover:bg-green-700 transition">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"/>
                        </svg>
                        Excel
                    </a>
                </div>
            </div>
        </div>

        <!-- Transactions Table -->
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <th class="px-6 py-3 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Date</th>
                        <th class="px-6 py-3 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Description</th>
                        <th class="px-6 py-3 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Reference</th>
                        <th class="px-6 py-3 text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Type</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Debit</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Credit</th>
                        <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Balance</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                    {% for txn in transactions %}
                    <tr class="text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700">
                        <td class="px-6 py-4">{{ txn.date[:10] if txn.date else '-' }}</td>
                        <td class="px-6 py-4">
                            {{ txn.description or txn.entry_number or '-' }}
                            {% if txn.payee_payer %}
                            <span class="text-gray-400 text-xs block">{{ txn.payee_payer }}</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4">{{ txn.reference or '-' }}</td>
                        <td class="px-6 py-4">
                            {% set source = txn.source_type or txn.entry_type %}
                            {% if source == 'sales_payment' %}
                            <span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Sales</span>
                            {% elif source == 'purchase_payment' %}
                            <span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300">Purchase</span>
                            {% elif source == 'customer_advance' %}
                            <span class="px-2 py-1 text-xs rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300">Customer Advance</span>
                            {% elif source == 'vendor_advance' %}
                            <span class="px-2 py-1 text-xs rounded-full bg-orange-100 text-orange-800 dark:bg-orange-900 dark:text-orange-300">Vendor Advance</span>
                            {% elif source == 'expense' %}
                            <span class="px-2 py-1 text-xs rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Expense</span>
                            {% elif source == 'other_income' %}
                            <span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300">Income</span>
                            {% elif txn.is_transfer %}
                            <span class="px-2 py-1 text-xs rounded-full bg-indigo-100 text-indigo-800 dark:bg-indigo-900 dark:text-indigo-300">Transfer</span>
                            {% elif source == 'opening_balance' %}
                            <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">Opening</span>
                            {% else %}
                            <span class="px-2 py-1 text-xs rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">{{ source }}</span>
                            {% endif %}
                        </td>
                        <td class="px-6 py-4 text-right {% if txn.debit > 0 %}text-green-600 dark:text-green-400 font-medium{% endif %}">
                            {% if txn.debit > 0 %}{{ txn.debit|currency }}{% else %}-{% endif %}
                        </td>
                        <td class="px-6 py-4 text-right {% if txn.credit > 0 %}text-red-600 dark:text-red-400 font-medium{% endif %}">
                            {% if txn.credit > 0 %}{{ txn.credit|currency }}{% else %}-{% endif %}
                        </td>
                        <td class="px-6 py-4 text-right font-medium">{{ txn.balance|currency }}</td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" class="px-6 py-8 text-center text-gray-500 dark:text-gray-400">
                            No transactions found
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
                {% if transactions %}
                <tfoot class="bg-gray-50 dark:bg-gray-700">
                    {% set total_debit = transactions | sum(attribute='debit') %}
                    {% set total_credit = transactions | sum(attribute='credit') %}
                    {% set calculated_balance = total_debit - total_credit %}
                    <tr>
                        <td colspan="4" class="px-6 py-3 text-sm font-medium text-gray-900 dark:text-white">Total</td>
                        <td class="px-6 py-3 text-right font-medium text-green-600 dark:text-green-400">{{ total_debit|currency }}</td>
                        <td class="px-6 py-3 text-right font-medium text-red-600 dark:text-red-400">{{ total_credit|currency }}</td>
                        <td class="px-6 py-3 text-right font-bold text-gray-900 dark:text-white">
                            {{ calculated_balance|currency }}
                        </td>
                    </tr>
                </tfoot>
                {% endif %}
            </table>
        </div>
    </div>
</div>
{% endblock %}
