{% extends "dashboard_layout.html" %}

{% block page_title %}Settings{% endblock %}

{% block content %}
<div class="space-y-6" x-data="{ activeTab: 'business' }">
    <!-- Tabs -->
    <div class="bg-white dark:bg-gray-800 rounded-2xl shadow-sm border border-gray-100 dark:border-gray-700">
        <div class="border-b border-gray-100 dark:border-gray-700">
            <nav class="flex space-x-1 p-2" aria-label="Tabs">
                <button @click="activeTab = 'business'" :class="activeTab === 'business' ? 'bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'" class="px-4 py-2 rounded-lg text-sm font-medium transition">
                    Business
                </button>
                <button @click="activeTab = 'users'" :class="activeTab === 'users' ? 'bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'" class="px-4 py-2 rounded-lg text-sm font-medium transition">
                    Users
                </button>
                <button @click="activeTab = 'roles'" :class="activeTab === 'roles' ? 'bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'" class="px-4 py-2 rounded-lg text-sm font-medium transition">
                    Roles
                </button>
                <button @click="activeTab = 'branches'" :class="activeTab === 'branches' ? 'bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'" class="px-4 py-2 rounded-lg text-sm font-medium transition">
                    Branches
                </button>
                <button @click="activeTab = 'fiscal_years'" :class="activeTab === 'fiscal_years' ? 'bg-primary-100 dark:bg-primary-900 text-primary-700 dark:text-primary-300' : 'text-gray-500 dark:text-gray-400 hover:text-gray-700 dark:hover:text-gray-300'" class="px-4 py-2 rounded-lg text-sm font-medium transition">
                    Fiscal Years
                </button>
            </nav>
        </div>
        
        <!-- Business Tab -->
        <div x-show="activeTab === 'business'" class="p-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Business Settings</h3>
            <form method="POST" action="{{ url_for('settings.update_business') }}" class="space-y-6 max-w-2xl">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                
                <div>
                    <label for="name" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Business Name</label>
                    <input type="text" name="name" id="name" value="{{ business.name if business else '' }}" 
                        class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-primary-500 focus:border-primary-500">
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" name="is_vat_registered" id="is_vat_registered" {{ 'checked' if business and business.is_vat_registered }} class="rounded border-gray-300 text-primary-600 focus:ring-primary-500">
                            <span class="ml-2 text-sm text-gray-700 dark:text-gray-300">VAT Registered</span>
                        </label>
                    </div>
                    <div>
                        <label for="vat_rate" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">VAT Rate (%)</label>
                        <input type="number" name="vat_rate" id="vat_rate" step="0.01" value="{{ business.vat_rate if business else '0' }}" 
                            class="w-full px-4 py-2 border border-gray-300 dark:border-gray-600 rounded-xl bg-gray-50 dark:bg-gray-700 dark:text-white focus:ring-primary-500 focus:border-primary-500">
                    </div>
                </div>
                
                <div class="flex justify-end">
                    <button type="submit" class="px-6 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-xl transition">
                        Save Changes
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Users Tab -->
        <div x-show="activeTab === 'users'" class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Users</h3>
                <a href="{{ url_for('settings.new_user') }}" class="inline-flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-xl transition text-sm">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                    </svg>
                    Add User
                </a>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">User</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Role</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                        {% for user in users %}
                        {% if user is mapping %}
                        <tr>
                            <td class="px-4 py-3">
                                <div class="flex items-center">
                                    <div class="w-8 h-8 bg-primary-100 dark:bg-primary-900 rounded-full flex items-center justify-center">
                                        <span class="text-primary-700 dark:text-primary-300 font-medium text-sm">{{ (user.get('username', 'U') or 'U')[:1]|upper }}</span>
                                    </div>
                                    <div class="ml-3">
                                        <div class="text-sm font-medium text-gray-900 dark:text-white">{{ user.get('username', 'N/A') }}</div>
                                        <div class="text-xs text-gray-500 dark:text-gray-400">{{ user.get('email', 'N/A') }}</div>
                                    </div>
                                </div>
                            </td>
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-white">
                                {% if user.get('is_superuser') %}
                                    <span class="px-2 py-1 text-xs font-medium rounded-full bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-300">Superuser</span>
                                {% elif user.get('roles') %}
                                    {% for role in user.get('roles', []) %}
                                    <span class="inline-block px-2 py-1 text-xs font-medium rounded-full bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300 mr-1">{{ role.get('role', {}).get('name', 'Unknown') if role.get('role') else 'Unknown' }}</span>
                                    {% endfor %}
                                {% else %}
                                    <span class="text-gray-400 dark:text-gray-500">No role</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3">
                                <span class="px-2 py-1 text-xs font-medium rounded-full {{ 'bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300' if user.get('is_active') else 'bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300' }}">
                                    {{ 'Active' if user.get('is_active') else 'Inactive' }}
                                </span>
                            </td>
                            <td class="px-4 py-3 text-right">
                                <div class="flex items-center justify-end space-x-3">
                                    <a href="{{ url_for('settings.view_user', user_id=user.get('id')) }}" class="text-gray-600 hover:text-gray-900 dark:text-gray-400 dark:hover:text-gray-200 text-sm" title="View">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                        </svg>
                                    </a>
                                    <a href="{{ url_for('settings.edit_user', user_id=user.get('id')) }}" class="text-primary-600 hover:text-primary-900 dark:text-primary-400 text-sm" title="Edit">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                        </svg>
                                    </a>
                                    {% if not user.get('is_superuser') and user.get('id') != session.get('user_data', {}).get('id') %}
                                    <button type="button" onclick="confirmDeleteUser({{ user.get('id') }}, '{{ user.get('username', 'User') }}')" class="text-red-600 hover:text-red-900 dark:text-red-400 text-sm" title="Delete">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                        </svg>
                                    </button>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% else %}
                        <tr>
                            <td colspan="4" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">No users found</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Roles Tab -->
        <div x-show="activeTab === 'roles'" class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Roles & Permissions</h3>
                <div class="flex items-center space-x-2">
                    {% if session.get('is_superuser') or session.get('user_data', {}).get('is_superuser') %}
                    <form method="POST" action="{{ url_for('settings.seed_permissions') }}" class="inline">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <button type="submit" class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 dark:bg-gray-700 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-300 font-medium rounded-xl transition text-sm">
                            <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd"/>
                            </svg>
                            Sync Permissions
                        </button>
                    </form>
                    {% endif %}
                    <a href="{{ url_for('settings.new_role') }}" class="inline-flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-xl transition text-sm">
                        <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                        </svg>
                        Add Role
                    </a>
                </div>
            </div>
            
            <div class="mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
                <p class="text-sm text-blue-700 dark:text-blue-300">
                    <strong>Tip:</strong> Roles define what features users can access. Create roles with specific permissions and assign them to users. The "Sync Permissions" button adds any new permissions to the system and updates the Admin role.
                </p>
            </div>
            
            <div class="space-y-4">
                {% for role in roles %}
                {% if role is mapping %}
                <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-medium text-gray-900 dark:text-white">{{ role.get('name', 'N/A') }}</h4>
                            <p class="text-sm text-gray-500 dark:text-gray-400">{{ role.get('description') or 'No description' }}</p>
                        </div>
                        <div class="flex items-center space-x-3">
                            <a href="{{ url_for('settings.edit_role', role_id=role.get('id')) }}" class="text-primary-600 hover:text-primary-900 dark:text-primary-400 text-sm">Edit</a>
                            {% if not role.get('is_system') %}
                            <form method="POST" action="{{ url_for('settings.delete_role', role_id=role.get('id')) }}" class="inline" onsubmit="return confirm('Are you sure you want to delete this role?');">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                <button type="submit" class="text-red-600 hover:text-red-900 dark:text-red-400 text-sm">Delete</button>
                            </form>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
                {% else %}
                <p class="text-gray-500 dark:text-gray-400 text-center py-8">No roles found</p>
                {% endfor %}
            </div>
        </div>
        
        <!-- Branches Tab -->
        <div x-show="activeTab === 'branches'" class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Branches</h3>
                <a href="{{ url_for('settings.new_branch') }}" class="inline-flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-xl transition text-sm">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                    </svg>
                    Add Branch
                </a>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                {% for branch in branches %}
                {% if branch is mapping %}
                <div class="p-4 border border-gray-200 dark:border-gray-700 rounded-xl relative">
                    {% if branch.get('is_default') %}
                    <span class="absolute top-2 right-2 px-2 py-1 text-xs font-medium rounded-full bg-primary-100 text-primary-800 dark:bg-primary-900 dark:text-primary-300">Default</span>
                    {% endif %}
                    <h4 class="font-medium text-gray-900 dark:text-white">{{ branch.get('name', 'N/A') }}</h4>
                    <p class="text-sm text-gray-500 dark:text-gray-400">{{ branch.get('currency', 'USD') }}</p>
                    <div class="mt-3 flex items-center space-x-3">
                        <a href="{{ url_for('settings.edit_branch', branch_id=branch.get('id')) }}" class="text-primary-600 hover:text-primary-900 dark:text-primary-400 text-sm">Edit</a>
                        {% if not branch.get('is_default') %}
                        <form method="POST" action="{{ url_for('settings.set_default_branch', branch_id=branch.get('id')) }}" class="inline">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="text-green-600 hover:text-green-900 dark:text-green-400 text-sm">Set as Default</button>
                        </form>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                {% else %}
                <div class="col-span-2 text-center py-8 text-gray-500 dark:text-gray-400">No branches found</div>
                {% endfor %}
            </div>
        </div>

        <!-- Fiscal Years Tab -->
        <div x-show="activeTab === 'fiscal_years'" class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Fiscal Years</h3>
                <a href="{{ url_for('settings.new_fiscal_year') }}" class="inline-flex items-center px-4 py-2 bg-primary-600 hover:bg-primary-700 text-white font-medium rounded-xl transition text-sm">
                    <svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd"/>
                    </svg>
                    Add Fiscal Year
                </a>
            </div>

            <div class="mb-4 p-4 bg-blue-50 dark:bg-blue-900/20 rounded-xl">
                <p class="text-sm text-blue-700 dark:text-blue-300">
                    <strong>Tip:</strong> Create fiscal years to organize your accounting periods. Each fiscal year can have monthly or quarterly periods. Only one fiscal year can be active (current) at a time.
                </p>
            </div>

            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Start Date</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">End Date</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Periods</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Status</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 dark:text-gray-300 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 dark:divide-gray-700">
                        {% for fy in fiscal_years %}
                        {% if fy is mapping %}
                        <tr>
                            <td class="px-4 py-3 text-sm font-medium text-gray-900 dark:text-white">{{ fy.get('name', 'N/A') }}</td>
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-white">{{ fy.get('start_date', 'N/A') }}</td>
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-white">{{ fy.get('end_date', 'N/A') }}</td>
                            <td class="px-4 py-3 text-sm text-gray-900 dark:text-white">{{ fy.get('periods_count', 0) }}</td>
                            <td class="px-4 py-3">
                                {% if fy.get('is_current') %}
                                <span class="px-2 py-1 text-xs font-medium rounded-full bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300">Current</span>
                                {% elif fy.get('is_closed') %}
                                <span class="px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800 dark:bg-gray-700 dark:text-gray-300">Closed</span>
                                {% else %}
                                <span class="px-2 py-1 text-xs font-medium rounded-full bg-yellow-100 text-yellow-800 dark:bg-yellow-900 dark:text-yellow-300">Open</span>
                                {% endif %}
                            </td>
                            <td class="px-4 py-3 text-right">
                                <div class="flex items-center justify-end space-x-3">
                                    {% if not fy.get('is_current') and not fy.get('is_closed') %}
                                    <form method="POST" action="{{ url_for('settings.set_current_fiscal_year', fy_id=fy.get('id')) }}" class="inline">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="text-green-600 hover:text-green-900 dark:text-green-400 text-sm">Set Current</button>
                                    </form>
                                    {% endif %}
                                    {% if not fy.get('is_closed') %}
                                    <form method="POST" action="{{ url_for('settings.close_fiscal_year', fy_id=fy.get('id')) }}" class="inline" onsubmit="return confirm('Are you sure you want to close this fiscal year? This action cannot be undone.');">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                        <button type="submit" class="text-red-600 hover:text-red-900 dark:text-red-400 text-sm">Close</button>
                                    </form>
                                    {% endif %}
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                        {% else %}
                        <tr>
                            <td colspan="6" class="px-4 py-8 text-center text-gray-500 dark:text-gray-400">No fiscal years found. Create your first fiscal year to get started.</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Delete Confirmation Modal -->
    <div id="deleteModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-2xl p-6 max-w-md w-full mx-4">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-2">Delete User</h3>
            <p class="text-gray-600 dark:text-gray-400 mb-4">Are you sure you want to delete user "<span id="deleteUserName"></span>"? This action cannot be undone.</p>
            <form id="deleteForm" method="POST" action="">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeDeleteModal()" class="px-4 py-2 text-gray-700 dark:text-gray-300 bg-gray-100 dark:bg-gray-700 rounded-xl hover:bg-gray-200 dark:hover:bg-gray-600 transition">Cancel</button>
                    <button type="submit" class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-xl transition">Delete</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
    function confirmDeleteUser(userId, username) {
        document.getElementById('deleteUserName').textContent = username;
        document.getElementById('deleteForm').action = "{{ url_for('settings.delete_user', user_id=0) }}".replace('0', userId);
        document.getElementById('deleteModal').classList.remove('hidden');
        document.getElementById('deleteModal').classList.add('flex');
    }
    
    function closeDeleteModal() {
        document.getElementById('deleteModal').classList.add('hidden');
        document.getElementById('deleteModal').classList.remove('flex');
    }
    
    // Close modal on outside click
    document.getElementById('deleteModal').addEventListener('click', function(e) {
        if (e.target === this) {
            closeDeleteModal();
        }
    });
    </script>
</div>
{% endblock %}
