{% extends "base.html" %}

{% block body %}
<div id="main-container" class="flex">
    <!-- Sidebar -->
    <aside 
        :class="{
            'translate-x-0': sidebarOpen,
            '-translate-x-full': !sidebarOpen,
            'sm:translate-x-0': true,
            'sm:w-20': sidebarCollapsed,
            'w-64': !sidebarCollapsed
        }" 
        class="fixed top-0 left-0 z-40 h-screen transition-all duration-300 bg-white dark:bg-gray-800 border-r border-gray-200 dark:border-gray-700"
        aria-label="Sidebar"
    >
        <div class="h-full px-3 py-4 overflow-y-auto">
            <!-- Logo -->
            <a href="{{ url_for('dashboard.index') }}" class="flex items-center ps-2.5 mb-5" :class="{ 'sm:justify-center': sidebarCollapsed }">
                <div class="w-8 h-8 bg-primary-600 rounded-lg flex items-center justify-center flex-shrink-0">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M4 4a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2H4zm2 6a2 2 0 114 0 2 2 0 01-4 0zm6 0a2 2 0 114 0 2 2 0 01-4 0z"/>
                    </svg>
                </div>
                <span class="self-center text-xl font-semibold whitespace-nowrap dark:text-white ml-3 transition-opacity duration-300" :class="{ 'sm:opacity-0 sm:w-0 sm:ml-0 sm:overflow-hidden': sidebarCollapsed }">Booklet</span>
            </a>
            
            <!-- Navigation -->
            <nav class="space-y-1" :class="{ 'sidebar-collapsed-nav': sidebarCollapsed }">
                <!-- Dashboard -->
                <a href="{{ url_for('dashboard.index') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group {{ 'bg-gray-100 dark:bg-gray-700' if request.endpoint == 'dashboard.index' else '' }}">
                    <svg class="w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"/>
                        <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"/>
                    </svg>
                    <span class="ms-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">Dashboard</span>
                </a>
                
                <!-- CRM -->
                {% if has_permission('customers:view') or has_permission('vendors:view') %}
                <div class="space-y-1" x-data="{ openCrm: false }">
                    <button type="button" class="flex items-center w-full p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group" x-on:click="openCrm = !openCrm">
                        <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                        </svg>
                        <span class="ms-3 flex-1 text-left transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">CRM</span>
                        <svg class="w-3 h-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }" fill="none" stroke="currentColor" viewBox="0 0 10 6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                        </svg>
                    </button>
                    <ul x-show="openCrm && !sidebarCollapsed" class="py-1 space-y-1">
                        {% if has_permission('customers:view') %}
                        <li>
                            <a href="{{ url_for('crm.list_customers') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Customers</a>
                        </li>
                        {% endif %}
                        {% if has_permission('vendors:view') %}
                        <li>
                            <a href="{{ url_for('crm.list_vendors') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Vendors</a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Inventory -->
                {% if has_permission('products:view') or has_permission('categories:view') or has_permission('stock:view') %}
                <div class="space-y-1" x-data="{ openInventory: false }">
                    <button type="button" class="flex items-center w-full p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group" x-on:click="openInventory = !openInventory">
                        <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z"/>
                        </svg>
                        <span class="ms-3 flex-1 text-left transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">Inventory</span>
                        <svg class="w-3 h-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }" fill="none" stroke="currentColor" viewBox="0 0 10 6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                        </svg>
                    </button>
                    <ul x-show="openInventory && !sidebarCollapsed" class="py-1 space-y-1">
                        {% if has_permission('products:view') %}
                        <li>
                            <a href="{{ url_for('inventory.list_products') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Products</a>
                        </li>
                        {% endif %}
                        {% if has_permission('categories:view') %}
                        <li>
                            <a href="{{ url_for('inventory.list_categories') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Categories</a>
                        </li>
                        {% endif %}
                        {% if has_permission('stock:view') %}
                        <li>
                            <a href="{{ url_for('inventory.stock_adjustments') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Stock Adjustments</a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Sales -->
                {% if has_permission('invoices:view') or has_permission('credit_notes:view') %}
                <div class="space-y-1" x-data="{ openSales: false }">
                    <button type="button" class="flex items-center w-full p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group" x-on:click="openSales = !openSales">
                        <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M1 1.5A1.5 1.5 0 012.5 0h12A1.5 1.5 0 0116 1.5v14l-7-3.5L2 15.5v-14z"/>
                        </svg>
                        <span class="ms-3 flex-1 text-left transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">Sales</span>
                        <svg class="w-3 h-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }" fill="none" stroke="currentColor" viewBox="0 0 10 6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                        </svg>
                    </button>
                    <ul x-show="openSales && !sidebarCollapsed" class="py-1 space-y-1">
                        {% if has_permission('invoices:view') %}
                        <li>
                            <a href="{{ url_for('sales.list_invoices') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Invoices</a>
                        </li>
                        {% endif %}
                        {% if has_permission('invoices:create') %}
                        <li>
                            <a href="{{ url_for('sales.new_invoice') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">New Invoice</a>
                        </li>
                        {% endif %}
                        {% if has_permission('credit_notes:view') %}
                        <li>
                            <a href="{{ url_for('sales.list_credit_notes') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Credit Notes</a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Purchases -->
                {% if has_permission('bills:view') or has_permission('debit_notes:view') %}
                <div class="space-y-1" x-data="{ openPurchases: false }">
                    <button type="button" class="flex items-center w-full p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group" x-on:click="openPurchases = !openPurchases">
                        <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3z"/>
                        </svg>
                        <span class="ms-3 flex-1 text-left transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">Purchases</span>
                        <svg class="w-3 h-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }" fill="none" stroke="currentColor" viewBox="0 0 10 6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                        </svg>
                    </button>
                    <ul x-show="openPurchases && !sidebarCollapsed" class="py-1 space-y-1">
                        {% if has_permission('bills:view') %}
                        <li>
                            <a href="{{ url_for('purchases.list_bills') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Bills</a>
                        </li>
                        {% endif %}
                        {% if has_permission('bills:create') %}
                        <li>
                            <a href="{{ url_for('purchases.new_bill') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">New Bill</a>
                        </li>
                        {% endif %}
                        {% if has_permission('debit_notes:view') %}
                        <li>
                            <a href="{{ url_for('purchases.list_debit_notes') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Debit Notes</a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Expenses -->
                {% if has_permission('expenses:view') %}
                <a href="{{ url_for('expenses.list_expenses') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group {{ 'bg-gray-100 dark:bg-gray-700' if 'expenses.' in request.endpoint|default('') else '' }}">
                    <svg class="w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5 2a2 2 0 00-2 2v14l3.5-2 3.5 2 3.5-2 3.5 2V4a2 2 0 00-2-2H5zm2.5 3a1.5 1.5 0 100 3 1.5 1.5 0 000-3zm6.207.293a1 1 0 00-1.414 0l-6 6a1 1 0 101.414 1.414l6-6a1 1 0 000-1.414zM12.5 10a1.5 1.5 0 100 3 1.5 1.5 0 000-3z" clip-rule="evenodd"/>
                    </svg>
                    <span class="ms-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">Expenses</span>
                </a>
                {% endif %}
                
                <!-- Other Income -->
                {% if has_permission('other_income:view') %}
                <a href="{{ url_for('other_incomes.list_other_incomes') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group {{ 'bg-gray-100 dark:bg-gray-700' if 'other_incomes.' in request.endpoint|default('') else '' }}">
                    <svg class="w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M12 7a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0V8.414l-4.293 4.293a1 1 0 01-1.414 0L8 10.414l-4.293 4.293a1 1 0 01-1.414-1.414l5-5a1 1 0 011.414 0L11 10.586 14.586 7H12z" clip-rule="evenodd"/>
                    </svg>
                    <span class="ms-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">Other Income</span>
                </a>
                {% endif %}
                
                <!-- Budgets -->
                {% if has_permission('budgets:view') %}
                <a href="{{ url_for('budgets.list_budgets') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group {{ 'bg-gray-100 dark:bg-gray-700' if 'budgets.' in request.endpoint|default('') else '' }}">
                    <svg class="w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/>
                        <path fill-rule="evenodd" d="M2 8v6a2 2 0 002 2h12a2 2 0 002-2V8H2zm2 2a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/>
                    </svg>
                    <span class="ms-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">Budgets</span>
                </a>
                {% endif %}
                
                <!-- Fixed Assets -->
                {% if has_permission('accounting:view') %}
                <a href="{{ url_for('fixed_assets.fixed_assets_list') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group {{ 'bg-gray-100 dark:bg-gray-700' if 'fixed_assets.' in request.endpoint|default('') else '' }}">
                    <svg class="w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M10 2a2 2 0 00-2 2v3.284A2 2 0 000-.932 0H4v-.932A2 2 0 00-2 2v-.932A2.002 2.002 0 01-2 2h.932A2 2 0 00-.932 0H2v.932A2 2 0 000 .932 0h2V5.5h3.236l4.932 4.932A2 2 0 01-2 2h-.932A2 2 0 01-1.414 0L11.586 8.414 4.414A2 2 0 00-1.414L-4.414-4.414a2 2 0 00-1.414-1.414l4.414-4.414a2 2 0 00-1.414 1.414l.293.293A1 1 0 01.414 0L10 2z" clip-rule="evenodd"/>
                    </svg>
                    <span class="ms-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">Fixed Assets</span>
                </a>
                {% endif %}
                
                <!-- Cash Book -->
                {% if has_permission('accounting:view') %}
                <a href="{{ url_for('cashbook.cashbook_list') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group {{ 'bg-gray-100 dark:bg-gray-700' if 'cashbook.' in request.endpoint|default('') else '' }}">
                    <svg class="w-5 h-5 text-gray-500 transition duration-75 dark:text-gray-400 group-hover:text-gray-900 dark:group-hover:text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/>
                        <path fill-rule="evenodd" d="M2 8v6a2 2 0 002 2h12a2 2 0 002-2V8H2zm2 2a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/>
                    </svg>
                    <span class="ms-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">Cash Book</span>
                </a>
                {% endif %}
                
                <!-- Accounting -->
                {% if has_permission('accounts:view') or has_permission('journal:view') or has_permission('reports:view') %}
                <div class="space-y-1" x-data="{ openAccounting: false }">
                    <button type="button" class="flex items-center w-full p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group" x-on:click="openAccounting = !openAccounting">
                        <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M4 4a2 2 0 00-2 2v4a2 2 0 002 2V6h10a2 2 0 00-2-2H4zm2 6a2 2 0 012-2h8a2 2 0 012 2v4a2 2 0 01-2 2H8a2 2 0 01-2-2v-4zm6 4a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                        <span class="ms-3 flex-1 text-left transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">Accounting</span>
                        <svg class="w-3 h-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }" fill="none" stroke="currentColor" viewBox="0 0 10 6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                        </svg>
                    </button>
                    <ul x-show="openAccounting && !sidebarCollapsed" class="py-1 space-y-1">
                        {% if has_permission('accounts:view') %}
                        <li>
                            <a href="{{ url_for('accounting.chart_of_accounts') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Chart of Accounts</a>
                        </li>
                        {% endif %}
                        {% if has_permission('journal:view') %}
                        <li>
                            <a href="{{ url_for('accounting.journal') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Journal</a>
                        </li>
                        <li>
                            <a href="{{ url_for('accounting.general_ledger') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">General Ledger</a>
                        </li>
                        {% endif %}
                        {% if has_permission('reports:view') %}
                        <li>
                            <a href="{{ url_for('accounting.balance_sheet') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Balance Sheet</a>
                        </li>
                        <li>
                            <a href="{{ url_for('accounting.profit_loss') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Profit & Loss</a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- HR -->
                {% if has_permission('employees:view') or has_permission('payroll:view') %}
                <div class="space-y-1" x-data="{ openHr: false }">
                    <button type="button" class="flex items-center w-full p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group" x-on:click="openHr = !openHr">
                        <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M9 6a3 3 0 11-6 0 3 3 0 016 0zM17 6a3 3 0 11-6 0 3 3 0 016 0zM12.93 17c.046-.327.07-.66.07-1a6.97 6.97 0 00-1.5-4.33A5 5 0 0119 16v1h-6.07zM6 11a5 5 0 015 5v1H1v-1a5 5 0 015-5z"/>
                        </svg>
                        <span class="ms-3 flex-1 text-left transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">HR & Payroll</span>
                        <svg class="w-3 h-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }" fill="none" stroke="currentColor" viewBox="0 0 10 6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                        </svg>
                    </button>
                    <ul x-show="openHr && !sidebarCollapsed" class="py-1 space-y-1">
                        {% if has_permission('employees:view') %}
                        <li>
                            <a href="{{ url_for('hr.list_employees') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Employees</a>
                        </li>
                        {% endif %}
                        {% if has_permission('payroll:view') %}
                        <li>
                            <a href="{{ url_for('hr.run_payroll') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Run Payroll</a>
                        </li>
                        <li>
                            <a href="{{ url_for('hr.payslips') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Payslips</a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Banking -->
                {% if has_permission('banking:view') or has_permission('transfers:view') or has_permission('reconciliation:view') %}
                <div class="space-y-1" x-data="{ openBanking: false }">
                    <button type="button" class="flex items-center w-full p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group" x-on:click="openBanking = !openBanking">
                        <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M4 4a2 2 0 00-2 2v1h16V6a2 2 0 00-2-2H4z"/>
                            <path fill-rule="evenodd" d="M2 8v6a2 2 0 002 2h12a2 2 0 002-2V8H2zm2 2a1 1 0 011-1h1a1 1 0 110 2H5a1 1 0 01-1-1zm5-1a1 1 0 100 2h1a1 1 0 100-2H9z" clip-rule="evenodd"/>
                        </svg>
                        <span class="ms-3 flex-1 text-left transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">Banking</span>
                        <svg class="w-3 h-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }" fill="none" stroke="currentColor" viewBox="0 0 10 6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                        </svg>
                    </button>
                    <ul x-show="openBanking && !sidebarCollapsed" class="py-1 space-y-1">
                        {% if has_permission('banking:view') %}
                        <li>
                            <a href="{{ url_for('banking.list_accounts') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Bank Accounts</a>
                        </li>
                        {% endif %}
                        {% if has_permission('transfers:view') %}
                        <li>
                            <a href="{{ url_for('banking.transfers') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Transfers</a>
                        </li>
                        {% endif %}
                        {% if has_permission('reconciliation:view') %}
                        <li>
                            <a href="{{ url_for('banking.reconciliation') }}" class="flex items-center w-full p-2 pl-11 text-gray-600 rounded-lg dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700">Reconciliation</a>
                        </li>
                        {% endif %}
                    </ul>
                </div>
                {% endif %}
                
                <!-- Reports -->
                {% if has_permission('reports:view') %}
                <a href="{{ url_for('reports.index') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
                    <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M6 2a2 2 0 00-2 2v12a2 2 0 002 2h8a2 2 0 002-2V7.414A2 2 0 0015.414 6L12 2.586A2 2 0 0010.586 2H6zm2 10a1 1 0 10-2 0v3a1 1 0 102 0v-3zm2-3a1 1 0 011 1v5a1 1 0 11-2 0v-5a1 1 0 011-1zm4-1a1 1 0 10-2 0v7a1 1 0 102 0V8z" clip-rule="evenodd"/>
                    </svg>
                    <span class="ms-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">Reports</span>
                </a>
                {% endif %}
            </nav>
            
            <!-- Settings Section -->
            {% if has_permission('users:view') or has_permission('roles:view') or has_permission('branches:view') %}
            <div class="pt-4 mt-4 border-t border-gray-200 dark:border-gray-700">
                <a href="{{ url_for('settings.index') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
                    <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M11.49 3.17c-.38-1.56-2.6-1.56-2.98 0a1.532 1.532 0 01-2.286.948c-1.372-.836-2.942.734-2.106 2.106.54.886.061 2.042-.947 2.287-1.561.379-1.561 2.6 0 2.978a1.532 1.532 0 01.947 2.287c-.836 1.372.734 2.942 2.106 2.106a1.532 1.532 0 012.287.947c.379 1.561 2.6 1.561 2.978 0a1.533 1.533 0 012.287-.947c1.372.836 2.942-.734 2.106-2.106a1.533 1.533 0 01.947-2.287c1.561-.379 1.561-2.6 0-2.978a1.532 1.532 0 01-.947-2.287c.836-1.372-.734-2.942-2.106-2.106a1.532 1.532 0 01-2.287-.947zM10 13a3 3 0 100-6 3 3 0 000 6z" clip-rule="evenodd"/>
                    </svg>
                    <span class="ms-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">Settings</span>
                </a>
            </div>
            {% endif %}
            
            <!-- Logout -->
            <div class="pt-4 mt-4 border-t border-gray-200 dark:border-gray-700">
                <a href="{{ url_for('auth.logout') }}" class="flex items-center p-2 text-gray-900 rounded-lg dark:text-white hover:bg-gray-100 dark:hover:bg-gray-700 group">
                    <svg class="w-5 h-5 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M3 3a1 1 0 00-1 1v12a1 1 0 102 0V4a1 1 0 00-1-1zm10.293 9.293a1 1 0 001.414 1.414l3-3a1 1 0 000-1.414l-3-3a1 1 0 10-1.414 1.414L14.586 9H7a1 1 0 100 2h7.586l-1.293 1.293z" clip-rule="evenodd"/>
                    </svg>
                    <span class="ms-3 transition-opacity duration-300" :class="{ 'sm:hidden': sidebarCollapsed }">Logout</span>
                </a>
            </div>
            
            <!-- Debug: Show permissions (for all users to troubleshoot) -->
            <div class="pt-4 mt-4 border-t border-gray-200 dark:border-gray-700" :class="{ 'sm:hidden': sidebarCollapsed }">
                <details class="text-xs">
                    <summary class="p-2 text-gray-500 dark:text-gray-400 cursor-pointer">Debug: Permissions</summary>
                    <div class="p-2 bg-gray-100 dark:bg-gray-700 rounded mt-1 max-h-40 overflow-y-auto">
                        <p class="font-medium mb-1">is_superuser: {{ session.get('is_superuser', False) }}</p>
                        <p class="font-medium mb-1">Permissions loaded: {{ (session.get('permissions', []) or [])|length }}</p>
                        <ul class="text-gray-600 dark:text-gray-400 text-xs">
                            {% for perm in (session.get('permissions', []) or []) %}
                            <li>{{ perm }}</li>
                            {% else %}
                            <li class="text-red-500">No permissions in session!</li>
                            {% endfor %}
                        </ul>
                        <form method="POST" action="{{ url_for('auth.refresh_permissions') }}" class="mt-2">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="text-primary-600 hover:underline text-xs">Refresh Permissions</button>
                        </form>
                    </div>
                </details>
            </div>
        </div>
    </aside>
    
    <!-- Main Content -->
    <div class="flex-1 transition-all duration-300" :class="sidebarCollapsed ? 'sm:ml-20' : 'sm:ml-64'">
        <!-- Header -->
        <header class="sticky top-0 z-30 flex items-center justify-between p-4 bg-white/80 dark:bg-gray-800/80 backdrop-blur-sm border-b dark:border-gray-700">
            <!-- Sidebar Toggle Button -->
            <button @click="sidebarCollapsed = !sidebarCollapsed; $dispatch('sidebar-toggle')" class="p-2 text-gray-500 dark:text-gray-400 hover:text-gray-600 dark:hover:text-gray-300 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg transition">
                <svg x-show="!sidebarCollapsed" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 19l-7-7 7-7m8 14l-7-7 7-7"></path>
                </svg>
                <svg x-show="sidebarCollapsed" class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 5l7 7-7 7M5 5l7 7-7 7"></path>
                </svg>
            </button>
            
            <!-- Page Title -->
            <h1 class="text-xl font-semibold text-gray-800 dark:text-white">{% block page_title %}Dashboard{% endblock %}</h1>
            
            <!-- Right Side Actions -->
            <div class="flex items-center space-x-4">
                <!-- Branch Selector (ONLY for superusers/admins with multiple branches) -->
                {% if session.get('is_superuser', False) and (session.get('branches') or [])|length > 1 %}
                <div class="relative" x-data="{ openBranch: false }">
                    <button @click="openBranch = !openBranch" type="button" class="flex items-center px-3 py-2 text-sm bg-gray-100 dark:bg-gray-700 rounded-lg hover:bg-gray-200 dark:hover:bg-gray-600 transition">
                        <svg class="w-4 h-4 mr-2 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                        </svg>
                        <span class="text-gray-700 dark:text-gray-300">{{ session.get('selected_branch_name', 'Select Branch') }}</span>
                        <svg class="w-4 h-4 ml-2" fill="none" stroke="currentColor" viewBox="0 0 10 6">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 4 4 4-4"/>
                        </svg>
                    </button>
                    <div x-show="openBranch" @click.away="openBranch = false" x-transition
                        class="absolute right-0 mt-2 w-48 bg-white dark:bg-gray-800 rounded-xl shadow-lg border border-gray-100 dark:border-gray-700 py-2 z-50">
                        {% for branch in (session.get('branches') or []) %}
                        <form method="POST" action="{{ url_for('settings.set_branch', branch_id=branch.get('id')) }}" class="block">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                            <button type="submit" class="w-full text-left px-4 py-2 text-sm {{ 'bg-primary-50 dark:bg-primary-900/20 text-primary-700 dark:text-primary-300' if session.get('selected_branch_id') == branch.get('id') else 'text-gray-700 dark:text-gray-300' }} hover:bg-gray-100 dark:hover:bg-gray-700">
                                {{ branch.get('name') }}
                                {% if branch.get('is_default') %}
                                <span class="text-xs text-gray-400 ml-1">(Default)</span>
                                {% endif %}
                            </button>
                        </form>
                        {% endfor %}
                    </div>
                </div>
                {% elif session.get('selected_branch_name') %}
                <!-- Show current branch for non-admin users (no selector, just display) -->
                <div class="flex items-center px-3 py-2 text-sm bg-gray-100 dark:bg-gray-700 rounded-lg">
                    <svg class="w-4 h-4 mr-2 text-gray-500 dark:text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd"/>
                    </svg>
                    <span class="text-gray-700 dark:text-gray-300">{{ session.get('selected_branch_name') }}</span>
                </div>
                {% endif %}
                
                <!-- Theme Toggle -->
                <button @click="toggleTheme" type="button" class="p-2 text-gray-500 rounded-lg hover:text-gray-900 hover:bg-gray-100 dark:text-gray-400 dark:hover:text-white dark:hover:bg-gray-700">
                    <span class="sr-only">Toggle theme</span>
                    <svg x-show="!isDark" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M17.293 13.293A8 8 0 016.707 2.707a8.001 8.001 0 1010.586 10.586z"></path>
                    </svg>
                    <svg x-show="isDark" class="w-6 h-6" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M10 2a1 1 0 011 1v1a1 1 0 11-2 0V3a1 1 0 011-1zm4 8a4 4 0 11-8 0 4 4 0 018 0zm-.464 4.95l.707.707a1 1 0 001.414-1.414l-.707-.707a1 1 0 00-1.414 1.414zm2.12-10.607a1 1 0 010 1.414l-.707.707a1 1 0 11-1.414-1.414l.707-.707a1 1 0 011.414 0zM17 11a1 1 0 100-2h-1a1 1 0 100 2h1zm-7 4a1 1 0 011 1v1a1 1 0 11-2 0v-1a1 1 0 011-1zM5.05 5.05A1 1 0 003.636 6.464l.707.707a1 1 0 001.414-1.414l-.707-.707zM3 11a1 1 0 100-2H2a1 1 0 100 2h1zM6.464 14.364a1 1 0 00-1.414 1.414l.707.707a1 1 0 001.414-1.414l-.707-.707z"></path>
                    </svg>
                </button>
                
                <!-- User Menu -->
                <div class="flex items-center">
                    <span class="text-sm text-gray-600 dark:text-gray-400 mr-2">Welcome, {{ session.get('username', 'User') }}</span>
                    <div class="w-8 h-8 bg-primary-100 rounded-full flex items-center justify-center">
                        <span class="text-primary-700 font-medium text-sm">{{ session.get('username', 'U')[:1]|upper }}</span>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content Area -->
        <main class="p-4 sm:p-6 lg:p-8">
            {% block content %}{% endblock %}
        </main>
    </div>
</div>

<!-- Mobile Sidebar Overlay -->
<div x-show="sidebarOpen" x-transition:enter="transition ease-out duration-300" x-transition:enter-start="opacity-0" x-transition:enter-end="opacity-100" x-transition:leave="transition ease-in duration-200" x-transition:leave-start="opacity-100" x-transition:leave-end="opacity-0" @click="sidebarOpen = false" class="fixed inset-0 z-30 bg-black/50 sm:hidden"></div>

{% endblock %}
